import{r as t,c as i,B as o,h as l}from"./p-8710117e.js";import{r as s}from"./p-370825cb.js";import"./p-86bd3473.js";import"./p-65879f9e.js";const n=class{constructor(o){t(this,o),this.fireenjinFetch=i(this,"fireenjinFetch",7),this.sumKeyToIndex={},this.groupToDateFormat={week:"yyyy-Q-MM-ww"},this.totallerId=void 0,this.type="line",this.totaller=void 0,this.labels=[],this.dataSets=[],this.groupBy="month",this.options=[],this.paths={},this.totals={},this.sumKeys=[]}ongroupByChanged(){this.populateGraph(this.totaller)}async onSuccess(t){var i,o,l,s,n,h,d,e,a,r,v;if("findTotaller"===t.detail.endpoint)this.totaller=(null===(o=null===(i=null==t?void 0:t.detail)||void 0===i?void 0:i.data)||void 0===o?void 0:o.totaller)||null,this.populateGraph(this.totaller);else if("listTotals"===(null===(l=null==t?void 0:t.detail)||void 0===l?void 0:l.endpoint)){console.log(t.detail),this.filterTotals((null===(n=null===(s=null==t?void 0:t.detail)||void 0===s?void 0:s.data)||void 0===n?void 0:n.totals)||[]);const i=null===(a=null===(e=null===(d=null===(h=null==t?void 0:t.detail)||void 0===h?void 0:h.event)||void 0===d?void 0:d.detail)||void 0===e?void 0:e.params)||void 0===a?void 0:a.totallerId;this.totals=Object.assign(Object.assign({},this.totals),{[i]:null===(v=null===(r=null==t?void 0:t.detail)||void 0===r?void 0:r.data)||void 0===v?void 0:v.totals})}}filterTotals(t){const i=[];let o=0;for(const l of(t||[]).reverse())"week"===this.groupBy&&this.groupToDateFormat.week&&o>12||(o+=1,i.push(null==l?void 0:l.id),this.sumKeys.map((t=>{this.dataSets[this.sumKeyToIndex[t]].data.push(l[t]||0)})),this.labels=i)}populateGraph(t){var i,o;this.sumKeys=Object.keys((null===(i=this.totaller)||void 0===i?void 0:i.sums)||{}),this.dataSets=Object.values((null===(o=this.totaller)||void 0===o?void 0:o.sums)||{}).map(((t,i)=>(this.sumKeyToIndex[null==t?void 0:t.id]=i,{label:(null==t?void 0:t.name)||(null==t?void 0:t.id),data:[],borderColor:(null==t?void 0:t.color)||this.randomColor(),backgroundColor:(null==t?void 0:t.color)||this.randomColor()})));const l=null==t?void 0:t.id;for(const[i,o]of Object.entries((null==t?void 0:t.paths)||{}))this.paths[l]||(this.paths[l]={}),this.paths[l][i]=o,this.groupBy===i&&this.fetchTotals(l,o),this.options.includes(i)||this.options.push(i);this.options=[...this.options],this.paths=Object.assign({},this.paths)}randomNumber(){return 10*Math.random()}randomColor(){return"#"+Math.floor(16777215*Math.random()).toString(16)}renderPathTemplate(t,i,o){return s(i,{totaller:{id:t},data:{createdAt:o||new Date}})}async fetchTotaller(){this.fireenjinFetch.emit({endpoint:"findTotaller",params:{id:this.totallerId}})}async fetchTotals(t,i,o){let l=this.renderPathTemplate(t,i,o);const s=l.split("/");s.pop(),l=s.join("/"),this.fireenjinFetch.emit({endpoint:"listTotals",params:{totallerId:t,path:l}})}async componentDidLoad(){(null==o?void 0:o.isBrowser)&&this.fetchTotaller()}render(){return l("fireenjin-graph",{type:this.type,labels:this.labels,datasets:this.dataSets,options:{plugins:{legend:{display:!0,labels:{color:"rgb(255, 99, 132)"}}}}})}static get watchers(){return{groupBy:["ongroupByChanged"]}}};n.style="floodteam-total-graph fireenjin-graph{display:block;margin:0 auto;width:75%}@media only screen and (max-width: 1050px ){floodteam-total-graph fireenjin-graph{width:95%}}";export{n as floodteam_total_graph}